version: '3.8'

services:
  backend:
    build:
      context: ./backend
    container_name: saqr-backend
    entrypoint: ["/entrypoint.sh"]
    environment:
      # Security
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-me}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DB: ${REDIS_DB:-0}
      # DB
      EXTERNAL_SQL_DB_HOST: ${EXTERNAL_SQL_DB_HOST:-sakila-mysql}
      EXTERNAL_SQL_DB_PORT: ${EXTERNAL_SQL_DB_PORT:-3306}
      EXTERNAL_SQL_DB_USER: ${EXTERNAL_SQL_DB_USER:-root}
      EXTERNAL_SQL_DB_PASSWORD: ${EXTERNAL_SQL_DB_PASSWORD:-rootpass}
      EXTERNAL_SQL_DB_NAME: ${EXTERNAL_SQL_DB_NAME:-sakila}
      EXTERNAL_SQL_DB_POOL_SIZE: ${EXTERNAL_SQL_DB_POOL_SIZE:-5}
      EXTERNAL_SQL_DB_MAX_OVERFLOW: ${EXTERNAL_SQL_DB_MAX_OVERFLOW:-10}
      EXTERNAL_SQL_DB_ECHO: ${EXTERNAL_SQL_DB_ECHO:-false}
      # AI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      AI_AGENT_MODEL: ${AI_AGENT_MODEL:-}
      BROWSER_EXECUTION_MODEL: ${BROWSER_EXECUTION_MODEL:-}
      BROWSER_PLANNER_MODEL: ${BROWSER_PLANNER_MODEL:-}
    depends_on:
      redis:
        condition: service_healthy
      sakila-mysql:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      args:
        EXPO_PUBLIC_API_URL: ${EXPO_PUBLIC_API_URL:-https://saqr-api.younesbenketira.com/api/v1}
        EXPO_PUBLIC_BRAND_NAME: ${EXPO_PUBLIC_BRAND_NAME:-Saqr}
        EXPO_PUBLIC_BRAND_SLUG: ${EXPO_PUBLIC_BRAND_SLUG:-saqr}
        EXPO_PUBLIC_APP_ENV: ${EXPO_PUBLIC_APP_ENV:-production}
    container_name: saqr-frontend
    environment:
      EXPO_PUBLIC_API_URL: ${EXPO_PUBLIC_API_URL:-https://saqr-api.younesbenketira.com/api/v1}
      EXPO_PUBLIC_BRAND_NAME: ${EXPO_PUBLIC_BRAND_NAME:-Saqr}
      EXPO_PUBLIC_BRAND_SLUG: ${EXPO_PUBLIC_BRAND_SLUG:-saqr}
      EXPO_PUBLIC_APP_ENV: ${EXPO_PUBLIC_APP_ENV:-production}
    depends_on:
      - backend

  redis:
    image: redis:7-alpine
    container_name: saqr-redis
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  sakila-mysql:
    build: ./scripts/sakila_db
    platform: linux/amd64
    container_name: saqr-sakila-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: sakila
    volumes:
      - sakila_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p\"$${MYSQL_ROOT_PASSWORD}\""]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  redis_data:
  sakila_mysql_data:
